(function(){function k(){null!==f&&f.disconnect();f=chrome.runtime.connect({name:"__dji__cowriter_port"})}function p(a,b,d){if(a.message===window.dji.messages.cwe.chrome.NOTIFICATION)return c&&c.notificationAvailable(a.reason,a.details),d(),!0;if(a.message===window.dji.messages.cwe.chrome.ENGINE_READY)Logger.instance.log("engineReady message received into: "+window.location),Logger.instance.log("       |-> message ="+a.message),Logger.instance.log("       |-> hostname="+window.location.hostname),
k(),null!==c&&c.restart(f);else if(a.message===window.dji.messages.cwe.chrome.SETUP)c&&c.setup(a.data);else{if(a.message===window.dji.messages.cwe.chrome.ACTIVATE)return Logger.instance.log("activate message received into: "+window.location),Logger.instance.log("       |-> message ="+a.message),Logger.instance.log("       |-> hostname="+window.location.hostname),b=c?c.activate(a.state):!1,d({token:a.token,active:b}),!0;if(a.message===window.dji.messages.cwe.chrome.DEACTIVATE)return Logger.instance.log("deactivate message received into: "+
window.location),Logger.instance.log("       |-> message ="+a.message),Logger.instance.log("       |-> hostname="+window.location.hostname),b=c?c.deactivate():!1,d({token:a.token,active:b}),!0;a.message===window.dji.messages.cwe.topics.CREATE?c&&c.createTopic(a.params):a.message===window.dji.messages.cwe.topics.DATA&&c&&c.topicsDataAvailable(a.data)}return!1}function q(a){if(a.data&&a.data.hasOwnProperty("key")&&"string"===typeof a.data.key&&a.data.key.startsWith("cwe-")&&a.data.hasOwnProperty("message")&&
a.data.message===window.dji.utils.MessageProxy.MSG_SRV_AVAILABLE&&a.data.service&&c.serviceIsSupported(a.data.service)){let b=new MessageChannel,d=new window.dji.utils.MessageProxy(`hookLoader::${a.data.service}`,{wnd:a.source,port:b.port1,service:a.data.service});a.source.postMessage({message:window.dji.utils.MessageProxy.MSG_SRV_AVAILABLE_ACK,timestamp:Date.now(),service:a.data.service,checksum:a.data.checksum},"*",[b.port2]);c.serviceAvailable(a.data.service,a.data.key,d)}}function r(a){e=document.createElement("dji-cowriter");
e.setAttribute("tabindex","-1");h=e.attachShadow({mode:"closed"});window.addEventListener("mousedown",function(b){if(b.target===e){b.preventDefault();b.stopPropagation();var d=h;let t=new MouseEvent(b.type,{screenX:b.screenX,screenY:b.screenY,clientX:b.clientX,clientY:b.clientY,ctrlKey:b.ctrlKey,shiftKey:b.shiftKey,altKey:b.altKey,metaKey:b.metaKey,button:b.button,buttons:b.buttons,relatedTarget:b.relatedTarget,region:b.region});(b=d.elementFromPoint(b.clientX,b.clientY))&&b.dispatchEvent(t)}},!0);
u(a);document.documentElement.appendChild(e);(new MutationObserver(function(){e!==document.documentElement.lastElementChild&&document.documentElement.insertBefore(e,null)})).observe(document.documentElement,{childList:!0});return{domContainer:h}}function u(a){let b=e.ownerDocument.createElement("style");b.textContent=a.css;h.append(b)}async function v(){return new Promise(a=>{chrome.runtime.sendMessage({message:window.dji.messages.cwe.ui.RESOURCES},a)})}function l(){let a=[document];CWEChromeUtilities.findValidDocumentElements(document,
a);for(let b=0;b<a.length;b++)a[b].removeEventListener("keydown",m),a[b].removeEventListener("keyup",n),a[b].addEventListener("keydown",m),a[b].addEventListener("keyup",n)}function m(a){"KeyM"!==a.code||!a.altKey||a.ctrlKey||a.shiftKey||a.metaKey?g=!1:(a.stopPropagation(),a.preventDefault(),g||(g=!0,c.toggleOnOff()))}function n(a){g&&(g=!1)}if(!CWEChromeUtilities.isLoginApp()){Logger.initialize();var f=null,c=null,e=null,h=null;window.cweMainView=new DjiCwuMainView;var g=!1;Logger.instance.log("Co:Writer injected into: "+
window.location);(async function(){let a=await v();await dji.ui.templatesRegistry.cache(a.html,"default",!1);await window.cweMainView.initialize();let b=r(a);chrome.runtime.onMessage.addListener(p);DexController.initialize(b,function(){k();c=new CWEChromeIME(b,f,function(){setTimeout(function(){Logger.instance.log("CWEChromeIME is ready in: "+window.location);window.addEventListener("message",q,!0)},0)});(new MutationObserver(function(d){l()})).observe(document.body,{childList:!0});l()})})()}})();
