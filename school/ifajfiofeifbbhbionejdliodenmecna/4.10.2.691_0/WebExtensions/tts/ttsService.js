window.dji=window.dji||{};
(function(c){function G(a){return a.replace(/(\w)([&#~$%*])(\d|\w)/g,function(b){return b[0]+" "+b[1]+" "+b[2]}).replace(/[()\[\]{}|]/g," ").replace(/[\u0022\u0060\u00B4\u2018\u2019\u201C\u201D]/g," ").replace(/\s+([.,:;])/g,function(b){return b[0]})}let w="",y="",x="",E="",m=[],n=-1,p=-1,t=-1,e=null,u=null,h=null,g=null,v=!1,z=!1,q=[];c.onError=null;c.onProgress=null;c.onStart=null;c.onStop=null;let H=function(a,b,d,f){w=a;v=!1;a:{if(window.dji.config.env().ttsServerURL)for(a=0;a<q.length;a++)if(q[a].voiceName===
b){y=q[a].voiceIdentifier;break a}v=!0;A(Error(b+" is not one of the known voices!"));c.onStop();y=void 0}x=JSON.parse(JSON.stringify(d));E=f;m=[];t=p=n=-1;u=e=null;z=!1},F=function(){c.onStart=c.onStart||function(){dji.logger.log("START PLAYBACK")};c.onProgress=c.onProgress||function(a,b){dji.logger.log(a,b)};c.onStop=c.onStop||function(){dji.logger.log("STOP PLAYBACK")};c.onError=c.onError||function(a){dji.logger.error(a)}},I=function(){if(e&&e.timings&&!(0>=e.timings.length)){var a=h.currentTime,
b=!1;for(let d=0>p?0:p;d<e.timings.length;d++)if(a>e.timings[d][1]&&a<e.timings[d][2]){b=!0;if(d!==p){p=d;break}return}if(b)if(0>p)c.onProgress(0,-1);else a=e.timings[p][0],t=w.indexOf(a,t),0<=t&&(c.onProgress(t,t+a.length),t+=a.length)}},B=function(){v||(!z&&n+1<m.length?null===u?setTimeout(B,50):(n++,e=u,u=null,p=-1,h.onplaying=J,h.onended=B,h.onerror=K,h.src="data:audio/ogg;base64,"+e.audio,h.play()):C())},J=function(){null!==g&&(clearInterval(g),g=null);e&&e.timings&&0<e.timings.length&&(g=setInterval(I,
50));n+1<m.length&&D()},K=function(){A(Error("Failed to switch audio track"));C()},D=function(a){if(n+1>=m.length)A(Error("This should never happen, getNextAudioData() called at bad time "+(n+1)+">="+m.length));else{var b=G(w.substring(m[n+1][0],m[n+1][1]));b={method:"POST",responseType:"json",timeout:15E3,url:window.dji.config.env().ttsServerURL+"/v1/synthesize",query:{access_token:E},contentType:"application/json",content:JSON.stringify({voice:y,settings:{pitch:x.pitch,rate:x.rate,volume:x.volume},
text:b})};jsdapi.http.sendRequest(b,function(d){if(!d||d.error||1<D.counter)d={audio:"INVALID_STREAM_DATA"};u=d;a&&a()})}},C=function(){null!==g&&clearInterval(g);g=null;h&&h.pause();v||(c.onStop(),v=!0)},A=function(a){z=!0;null!==g&&clearInterval(g);g=null;c.onError(a)};F();let L=function(a){a=(new window.ParseEnglish).parse(a);let b=[],d=function(f){let r;if("SentenceNode"===f.type){let k=f.position.start.offset,l;for(r=0;r<f.children.length&&!(k+1E3>f.position.end.offset);r++)if(l=f.children[r],
"PunctuationNode"===l.type&&l.position.end.offset>k+600||"WhiteSpaceNode"===l.type&&l.position.end.offset>k+900||l.position.start.offset<k+1E3&&l.position.end.offset>=k+1E3)b.push([k,l.position.end.offset]),k=l.position.end.offset;f.position.end.offset>k&&b.push([k,f.position.end.offset])}else if(f.children)for(r=0;r<f.children.length;r++)d(f.children[r])};d(a);return b};c.play=function(a,b,d){F();H(a,b,d,window.jsdapi.getAuthToken());h=document.getElementById("dji-tts-service-audio");m=L(w);D(function(){c.onStart();
B()})};c.stop=function(){C()};c.loadVoices=function(a){if(0<q.length)return a(q);let b={method:"GET",url:window.dji.config.env().ttsServerURL+"/v1/voices",timeout:5E3,responseType:"json"};jsdapi.http.sendRequest(b,function(d){if(0>=q.length){if(!d||d.error)return a(null);q=d}a(q)})};c.isOnlineVoice=function(a){return 0<a.indexOf("(Online)")}})(window.dji.tts_service=window.dji.tts_service||{});
