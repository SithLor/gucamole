window.cwe=window.cwe||{};window.cwe.ime=window.cwe.ime||{};window.cwe.ime.tasks=window.cwe.ime.tasks||{};(function(d){d.ttsSessionID=-1})(window.cwe.ime.tasks.Statics=window.cwe.ime.tasks.Statics||{});
window.cwe.ime.tasks.IMETaskEventGuard=function(){class d{constructor(a,b){this.m_eventQueue=[];this.m_document=a;this.m_activeView=this.m_activeElement=this.m_task=null;this.m_scheduler=b;this.m_eventListener=c=>{this.__onEvent(c)}}isActive(){return null!==this.m_activeElement}activate(a){this.isActive()||(this.m_task=a,this.__findActiveElementAndView(this.m_document),this.__addEventListeners())}deactivate(){if(this.isActive()&&this.m_task){var a=this.m_task.IME;this.m_task=null;a=new window.cwe.ime.tasks.PostEventQueueIMETask(a);
this.m_scheduler.scheduleImmediately(a,{eventQueue:this.m_eventQueue,execDeleteOnBackspace:!CWEChromeUtilities.isTwitter(),startCallback:()=>{this.__removeEventListeners()},doneCallback:()=>{this.m_activeElement=null;this.m_eventQueue=[]}})}}__findActiveElementAndView(a){let b=a;for(;b&&b.activeElement;){let c=b.activeElement;c.shadowRoot&&(c=c.shadowRoot.activeElement);if("IFRAME"!==c.tagName.toUpperCase())break;b=c.contentDocument}this.m_activeView=b?b.defaultView:a.defaultView;this.m_activeElement=
b&&b.activeElement?b.activeElement:a.activeElement?a.activeElement:this.m_activeView}__onEvent(a){if(!a.isTrusted||"input"===a.type)window.dji.logger.warn("Unexpected event received: ",a);else if(0!==this.m_eventQueue.length||"keyup"!==a.type){var b=a instanceof MouseEvent;if(!b||null===a.target||"DJI-COWRITER"!==a.target.tagName.toUpperCase())if(b||(a.stopImmediatePropagation(),"keydown"===a.type?this.__isNonPrintableEvent(a)?a.preventDefault():(b=this.m_task?this.m_task.IME:null)&&null!==b.suggestionFromEvent(a)&&
a.preventDefault():"keypress"===a.type&&a.preventDefault(),this.m_eventQueue.push(a)),this.m_task&&"keyup"!==a.type)this.m_task.onGuardedEvent(a)}}__isNonPrintableEvent(a){return"function"===typeof a.isNonPrintable?a.isNonPrintable():1===a.key.length?!1:!0}__addEventListeners(){this.m_activeView.addEventListener("keydown",this.m_eventListener,!0);this.m_activeView.addEventListener("keypress",this.m_eventListener,!0);this.m_activeView.addEventListener("keyup",this.m_eventListener,!0);this.m_activeElement.addEventListener("mousedown",
this.m_eventListener,!0);this.m_activeElement.addEventListener("mouseup",this.m_eventListener,!0);this.m_activeElement.ownerDocument&&this.m_activeElement.ownerDocument!==this.m_document&&(this.m_document.addEventListener("mousedown",this.m_eventListener,!0),this.m_document.addEventListener("mouseup",this.m_eventListener,!0))}__removeEventListeners(){this.m_activeView.removeEventListener("keydown",this.m_eventListener,!0);this.m_activeView.removeEventListener("keypress",this.m_eventListener,!0);this.m_activeView.removeEventListener("keyup",
this.m_eventListener,!0);this.m_activeElement.removeEventListener("mousedown",this.m_eventListener,!0);this.m_activeElement.removeEventListener("mouseup",this.m_eventListener,!0);this.m_activeElement.ownerDocument&&this.m_activeElement.ownerDocument!==this.m_document&&(this.m_document.removeEventListener("mousedown",this.m_eventListener,!0),this.m_document.removeEventListener("mouseup",this.m_eventListener,!0))}}return d}();
class IMETask extends window.dji.twp.AbstractTask{constructor(d,a=null){super();this.m_ime=d;this.m_doneCallback=this.m_startCallback=void 0;this.m_isStopping=this.m_isCancelled=this.m_isRunning=!1;this.m_eventGuard=a}get IME(){return this.m_ime}onGuardedEvent(d){}isCancelled(){return this.m_isCancelled}isRunning(){return this.m_isRunning}isStopping(){return this.m_isStopping}cancel(){this.m_isCancelled||(this.m_isCancelled=!0,this.__onCancel(),this.stop())}stop(){this.m_isRunning&&this.__canStop()&&
(this.m_isRunning=!1,this.m_isStopping=!0,this.__onStop(),this.m_eventGuard?window.requestIdleCallback(()=>{this.m_eventGuard.deactivate();this.m_isStopping=!1}):this.m_isStopping=!1,window.dji.utils.callMethod(this.m_doneCallback))}run(d){this.m_isRunning=!0;this.m_isCancelled=!1;this.m_startCallback=d.startCallback;this.m_doneCallback=d.doneCallback;window.dji.utils.callMethod(this.m_startCallback);this.m_eventGuard&&window.requestIdleCallback(()=>{this.m_eventGuard.activate(this)});this.__onRun(d)}__canStop(){return!0}__onCancel(){}__onStop(){}__onRun(d){throw Error("Not implemented!");
}}
window.cwe.ime.tasks.PostEventQueueIMETask=function(){class d extends IMETask{constructor(a){super(a);this.m_eventQueue=[];this.m_execDeleteOnBackspace=this.m_imeModifiedKeyDown=!1}__caStop(){return 0===this.m_eventQueue.length}__onRun(a){this.m_eventQueue=a.eventQueue||[];this.m_imeModifiedKeyDown=!1;this.m_execDeleteOnBackspace=!!a.execDeleteOnBackspace;a=null;for(let b of this.m_eventQueue){let c;c="mousedown"===b.type||"mouseup"===b.type?new MouseEvent(b.type,b):new KeyboardEvent(b.type,b);a&&
a.defaultPrevented&&"keydown"===a.type&&"keypress"===c.type||(b.target.dispatchEvent(c),"keydown"===b.type?this.__postProcessKeyDownEvent(b):"keypress"===b.type&&this.__postProcessKeyPressEvent(b),a=c)}this.m_eventQueue=[];this.stop()}__postProcessKeyDownEvent(a){this.m_imeModifiedKeyDown=!1;if("Backspace"===a.key)this.m_execDeleteOnBackspace&&a.target.ownerDocument.execCommand("delete",!1,null);else if("Delete"===a.key)a.target.ownerDocument.execCommand("forwardDelete",!1,null);else if("Enter"===
a.key){var b=a.target.ownerDocument.createEvent("TextEvent");b.initTextEvent("textInput",!0,!0,window,String.fromCharCode(10));a.target.dispatchEvent(b);a.target.ownerDocument.execCommand("insertParagraph",!1,null)}else b={text:a.key,selection:{}},this.IME.__handleInput(a.key,b),this.m_imeModifiedKeyDown=a.key!==b.text}__postProcessKeyPressEvent(a){this.m_imeModifiedKeyDown?this.m_imeModifiedKeyDown=!1:null===this.IME.suggestionFromEvent(a)&&a.target.ownerDocument.execCommand("insertText",!1,a.key)}}
return d}();
window.cwe.ime.tasks.ReadTextIMETask=function(){class d extends IMETask{constructor(a,b=null){super(a,b);this.m_highlighter=null;this.m_ttsSessionID=-1;this.m_options=null;this.m_readingFromCaretToEnd=!1;this.m_highlightStatusChangedListener=c=>{this.__onTextHighlightStatusChanged(c.detail.source,c.detail.status)};this.m_portListener=c=>{if(!Number.isSafeInteger(c.sessionID)||c.sessionID!==this.m_ttsSessionID)return!1;this.m_highlighter.onTTSMessage(c);if(c.message===window.dji.messages.cwe.tts.STOP||c.message===
window.dji.messages.cwe.tts.ERROR||this.m_isCancelled)this.IME.m_port.onMessage.removeListener(this.m_portListener),this.m_ttsSessionID=-1,this.stop();return!0}}onGuardedEvent(a){this.m_highlighter&&(this.m_highlighter.highlightWhileTypingIsEnabled?this.stop():a instanceof MouseEvent&&null!==a.target&&"DJI-COWRITER"===a.target.tagName.toUpperCase()?this.stop():this.cancel())}__onCancel(){this.m_highlighter&&this.m_highlighter.cancel()}__onStop(){0<=this.m_ttsSessionID&&(this.m_highlighter.reset(()=>
{this.IME.__postStopSpeak()}),this.m_ttsSessionID=-1)}__onRun(a){this.m_highlighter=a.highlighter;this.m_options=a;this.m_readingFromCaretToEnd=!1;this.IME.__postStopSpeak();this.m_highlighter.reset(()=>{this.__mapText()})}__mapText(){if(this.isRunning()){var a=this.m_options.mappingOptions;window.dji.utils.isNullOrUndefined(a.activate)||a.activate?(this.m_highlighter.setGranularity(this.m_options.granularity),a={origin:a.type??window.dji.highlighting.Origin.FROM_CARET_TO_END,skip:a.skip,skipCount:a.skipCount,
skipConsecutiveSeparatorsAsOne:a.skipConsecutiveSeparatorsAsOne??!0},this.m_readingFromCaretToEnd=a.origin===window.dji.highlighting.Origin.FROM_CARET_TO_END,this.m_highlighter.mapTextForHighlighting(a,b=>{this.__postSpeakAndStartHighlighting(b)})):this.stop()}}__postSpeakAndStartHighlighting(a){this.__isTextValidForTTS(a)?this.isRunning()&&(!this.m_options.isOffice365||this.m_options.fromSpeechRecognition||this.m_options.mappingOptions.skip<window.dji.mapping.Skip.NONE||this.m_options.mappingOptions.skip===
window.dji.mapping.Skip.SENTENCE||this.m_options.mappingOptions.type!==window.dji.highlighting.Origin.BACK_TO_CARET?this.__postSpeak(a):this.m_highlighter.reset(()=>{this.__postSpeak(a)})):this.stop()}__isTextValidForTTS(a){if(window.dji.utils.isNullOrUndefined(a))return!1;const b=a.length;for(let c=0;c<b;++c){const f=a[c];if(!window.dji.charSet.invisibleWhiteSpace.characterIsMember(f)&&!window.dji.charSet.wordSeparator.characterIsMemberNoHypen(f))return!0}window.dji.logger.warn(`Text not valid for TTS: #${a}#`);
return!1}__postSpeak(a){this.isRunning()&&(++window.cwe.ime.tasks.Statics.ttsSessionID===Number.MAX_SAFE_INTEGER&&(window.cwe.ime.tasks.Statics.ttsSessionID=0),this.m_ttsSessionID=window.cwe.ime.tasks.Statics.ttsSessionID,this.m_highlighter.addEventListener("highlighting-status-changed",this.m_highlightStatusChangedListener),this.IME.m_port.onMessage.addListener(this.m_portListener),this.IME.__postScheduleSpeak(a,!0,this.m_ttsSessionID,this.m_options.mappingOptions.settings))}__onTextHighlightStatusChanged(a,
b){b||(a.removeEventListener("highlighting-status-changed",this.m_highlightStatusChangedListener),this.m_readingFromCaretToEnd&&this.IME.__onContextChanged(!0))}}return d}();
window.cwe.ime.tasks.WriteTextTwitterIMETask=function(){class d extends IMETask{constructor(a){super(a);this.m_input=this.m_editor=this.m_document=void 0}__onRun(a){this.m_document=a.document;this.m_editor=a.editor;if((this.m_input=a.input)&&0!==this.m_input.length&&this.m_document){var b=String.fromCharCode(8205),c=b.toUpperCase()===b;a={cancelable:!0,bubbles:!0,key:b,shiftKey:c};var f={cancelable:!0,bubbles:!0,key:"Shift",code:"ShiftLeft"};if(c){var e=new KeyboardEvent("keydown",f);this.m_editor.dispatchEvent(e)}e=
new KeyboardEvent("keydown",a);this.m_editor.dispatchEvent(e);e=new KeyboardEvent("keypress",a);this.m_editor.dispatchEvent(e);e=this.m_document.createEvent("TextEvent");e.initTextEvent("textInput",!0,!0,window,b);this.m_editor.dispatchEvent(e);c&&(b=new KeyboardEvent("keyup",f),this.m_editor.dispatchEvent(b));a=new KeyboardEvent("keyup",a);this.m_editor.dispatchEvent(a);window.requestIdleCallback(()=>{this.m_document.execCommand("insertText",!1,this.m_input);this.stop()})}else this.stop()}}return d}();
