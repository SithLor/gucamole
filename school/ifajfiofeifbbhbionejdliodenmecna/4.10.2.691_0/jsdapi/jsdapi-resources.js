window.jsdapi=window.jsdapi||{};
(function(n){function t(a,b){window.jsdapi.authorize(function(d){if(!d)return f(b,{errorCode:401});d={responseType:"json",method:"GET",url:u(a,"manifest.json"),query:{validator:q.dapi,access_token:d}};window.jsdapi.http.sendRequest(d,function(c,e,h){if(!c||c.errorCode)return f(b,{errorCode:500});f(b,null,c)})})}function x(a,b,d,c,e){t(a,function(h,g){if(h||!g||g.errorCode)return f(e,h||{errorCode:500});h=g.hasOwnProperty(b)?g[b]||void 0:void 0;let l=void 0;if(h&&h instanceof Array)for(let k=0;k<h.length;k++)if(h[k][d]===
c){l=h[k];break}if(!l)return f(e,{errorCode:404});let p=`${a}/${l.location}`;t(p,function(k,m){if(k||!m||m.errorCode)return f(e,{errorCode:500});m.location=p;f(e,null,m,l,g)})})}function E(a,b,d,c,e,h,g,l){x(a,b,d,c,function(p,k,m,r){if(p||!k||!k.files||!m||!r)return f(l,p||{errorCode:500});let y=JSON.stringify(r),F=CryptoJS.MD5(y).toString(),G=`${e}/manifest.json`,H=`${e}/checksum`,z=JSON.stringify(k),A=CryptoJS.MD5(z).toString(),w=B(e,m.location),I=`${w}/manifest.json`,C=`${w}/checksum`,O=function(){J(k,
w,h,g,function(v){if(v.errorCode)return f(l,v);g.writeFile(I,z,function(K){if(!K)return f(l,{errorCode:500});g.writeFile(C,A,function(L){if(!L)return f(l,{errorCode:500});g.writeFile(G,y,function(M){if(!M)return f(l,{errorCode:500});g.writeFile(H,F,function(N){return N?f(l,{errorCode:0}):f(l,{errorCode:500})})})})})})};g.readFileAsText(C,function(v){if(v===A)return f(l,{errorCode:0});g.removeDirectory(e,O)})})}function J(a,b,d,c,e){let h={},g=[];for(let k=0;k<a.files.length;k++){let m=a.files[k].replace(/\\/g,
"/").split("/");d.hasOwnProperty(m[0])&&(m[0]=d[m[0]]);let r=B(b,...m.slice(0,m.length-1));g.push({remote:`${a.location}/${a.files[k]}`,local:`${r}/${m[m.length-1]}`});h[r]=!0}let l=-1,p=function(k){if(k&&k.errorCode)return f(e,k);if(g.length<=++l)return f(e,{errorCode:0});P(g[l].remote,g[l].local,c,p)};c.createDirectories(Object.keys(h),function(){p(void 0)})}function P(a,b,d,c){window.jsdapi.authorize(function(e){if(!e)return f(c,{errorCode:401});e={responseType:"binary",method:"GET",url:u(a),query:{validator:q.dapi,
access_token:e}};window.jsdapi.http.sendRequest(e,function(h,g,l){if(!h||200!==g)return f(c,{errorCode:500});d.writeFile(b,h,function(p,k){if(!p)return f(c,{errorCode:500});f(c,{errorCode:0,fileEntry:k})})})})}async function D(a,b,d){let c=await window.jsdapi.resources.downloadManifestAsync(a),e=JSON.stringify(c),h=CryptoJS.MD5(e).toString();if(await d.readFileAsTextAsync(`${b}/checksum`)===h)return!1;await d.removeDirectoryAsync(b);await d.createDirectoryAsync(b);await d.writeFileAsTextAsync(`${b}/manifest.json`,
e);await d.writeFileAsText(`${b}/checksum`,h);for(let g of c.files)await window.jsdapi.resources.downloadResourceFileAsync(`${a}/${g}`,`${b}/${g}`,d);return!0}function u(...a){let b=q.resources;if(0<a.length){let d=[];for(let c=0;c<a.length;c++)a[c]&&0<a[c].length&&d.push(a[c]);d=d.join("/");b=0<d.length&&"/"===d[0]?b+d:b+("/"+d)}return b}function B(a){return[...arguments].join("/")}function f(a){if(a)try{a.apply(this,[].slice.call(arguments).splice(1))}catch(b){Logger.instance.error(b)}}let q={resources:void 0};
const Q=Object.create(null,{Hunspell:{value:"common/hunspell"},SensitiveWords:{value:"cowriter/sensitive-words"},Prediction:{value:"cowriter/prediction"},SpecialPredictions:{value:"cowriter/special-predictions"}});n.Type=Q;n.setUrls=function(a){q.dapi=a.dapi;q.resources=a.resources};n.downloadManifest=t;n.downloadManifestAsync=async function(a){let b=await window.jsdapi.authorizeAsync();b||(b=btoa(chrome.runtime.getURL("")));a={responseType:"json",method:"GET",url:u(a,"manifest.json"),query:{validator:q.dapi,
access_token:b}};a=await window.jsdapi.http.sendRequestAsync(a);if(200!==a.status)throw a=Error(),a.code=500,a;return await a.json()};n.downloadResourceManifest=x;n.listAvailableLanguages=function(a,b){t(a,function(d,c){if(d||!c||c.errorCode||!c.languages)return f(b,{errorCode:500});f(b,c)})};n.downloadLanguageResources=function(a,b,d,c,e,h){E(b,"languages","language_code",a,d,c,e,h)};n.downloadResourceFileAsync=async function(a,b,d,c){var e=await window.jsdapi.authorizeAsync();e||(e=btoa(chrome.runtime.getURL("")));
e={method:"GET",url:u(a),query:{validator:q.dapi,access_token:e}};a=await window.jsdapi.http.sendRequestAsync(e);if(200!==a.status)throw Error(`Error downloading file ${e.url}`);e=a.blob;c&&(c=a.headers.get("content-type"))&&c.startsWith("text/plain")&&(e=a.text);c=await e.call(a);return d.writeFileAsync(b,c)};n.downloadSensitiveWordsResourcesAsync=async function(a,b){return D(window.jsdapi.resources.Type.SensitiveWords,a,b)};n.downloadSpecialPredictionsResourcesAsync=async function(a,b){return D(window.jsdapi.resources.Type.SpecialPredictions,
a,b)}})(window.jsdapi.resources=window.jsdapi.resources||{});
